{% extends 'base.html' %}
{% block content %}
<div class="space-y-6">
  <div class="space-y-2">
    <h1 class="text-2xl font-semibold">サービス予約・見積</h1>
    <p class="text-sm text-slate-600">ステップに沿ってご入力ください。途中でページを離れても内容はブラウザに保存されます。</p>
  </div>

  <div class="space-y-4">
    <ol
      id="booking-progress"
      data-steps='{{ step_sequence | tojson }}'
      class="flex flex-col gap-2 md:flex-row"
    >
      {% for step_name in step_sequence %}
      <li class="flex-1">
        <div
          data-step="{{ step_name }}"
          data-base-class="flex items-center justify-between gap-3 rounded-lg border p-3 text-sm font-medium transition md:justify-center"
          class="flex items-center justify-between gap-3 rounded-lg border border-slate-200 bg-white p-3 text-sm font-medium text-slate-400 transition md:justify-center"
        >
          <span class="inline-flex h-6 w-6 items-center justify-center rounded-full border border-current text-xs">{{ loop.index }}</span>
          <span class="flex-1 text-left md:text-center">{{ step_labels[step_name] }}</span>
        </div>
      </li>
      {% endfor %}
    </ol>

    <div class="relative">
      {{ initial_step_html | safe }}
    </div>
  </div>
</div>

<script>
(function () {
  const STORAGE_KEY = "booking-progress";

  function safeParse(value) {
    if (!value) return {};
    try {
      return JSON.parse(value);
    } catch (err) {
      console.warn("Failed to parse stored progress", err);
      return {};
    }
  }

  function getStoredProgress() {
    return safeParse(sessionStorage.getItem(STORAGE_KEY));
  }

  function storeProgress(data) {
    sessionStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  }

  function mergeProgress(payload) {
    const next = { ...getStoredProgress(), ...(payload || {}) };
    storeProgress(next);
    return next;
  }

  function updateIndicator() {
    const progressEl = document.getElementById("booking-progress");
    const stepContainer = document.getElementById("booking-step");
    if (!progressEl || !stepContainer) return;
    const steps = safeParse(progressEl.dataset.steps);
    const currentStep = stepContainer.dataset.step;
    const currentIndex = steps.indexOf(currentStep);

    progressEl.dataset.currentStep = currentStep;
    progressEl.querySelectorAll("[data-step]").forEach((element) => {
      const base = element.dataset.baseClass || element.className;
      const stepName = element.dataset.step;
      const idx = steps.indexOf(stepName);
      let stateClass = " bg-white border-slate-200 text-slate-400";
      if (idx < currentIndex) {
        stateClass = " bg-emerald-500 border-emerald-500 text-white";
      } else if (idx === currentIndex) {
        stateClass = " bg-slate-900 border-slate-900 text-white";
      }
      element.className = `${base}${stateClass}`;
      element.setAttribute("aria-current", idx === currentIndex ? "step" : "false");
    });
  }

  function syncFromDataset() {
    const stepContainer = document.getElementById("booking-step");
    if (!stepContainer) return;
    const payload = safeParse(stepContainer.dataset.progress);
    mergeProgress(payload);
  }

  function hydrateFormFields() {
    const stepContainer = document.getElementById("booking-step");
    if (!stepContainer) return;
    const form = stepContainer.querySelector("form[data-step-form]");
    if (!form) return;
    const data = getStoredProgress();
    Object.entries(data).forEach(([key, value]) => {
      const field = form.elements.namedItem(key);
      if (!field) return;
      if (field.type === "checkbox") {
        field.checked = value === true || value === "on" || value === "true";
      } else if (field.type === "radio") {
        const radio = form.querySelector(`input[name="${key}"][value="${value}"]`);
        if (radio) radio.checked = true;
      } else {
        field.value = value ?? "";
      }
    });
  }

  function collectFormData(form) {
    const formData = new FormData(form);
    const payload = {};
    formData.forEach((value, key) => {
      const field = form.elements.namedItem(key);
      if (field && field.type === "checkbox") {
        payload[key] = field.checked;
      } else {
        payload[key] = value;
      }
    });
    Array.from(form.elements).forEach((field) => {
      if (field.type === "checkbox" && !(field.name in payload)) {
        payload[field.name] = field.checked;
      }
    });
    return payload;
  }

  function handleFormChange(event) {
    const form = event.target.closest("form[data-step-form]");
    if (!form) return;
    mergeProgress(collectFormData(form));
  }

  function initializeStep() {
    syncFromDataset();
    hydrateFormFields();
    updateIndicator();
  }

  document.addEventListener("input", handleFormChange);
  document.addEventListener("change", handleFormChange);
  document.addEventListener("htmx:afterSwap", (event) => {
    if (event.target.id === "booking-step") {
      initializeStep();
    }
  });
  window.addEventListener("load", initializeStep);
})();
</script>
{% endblock %}
